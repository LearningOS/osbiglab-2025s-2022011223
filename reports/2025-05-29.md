# 2025-05-29 汇报

## 工作进展

本项目成功运用 Kani 形式化验证工具，对 `sys_execve` 系统调用在 [Commit 4f2ceae](https://github.com/eternalcomet/undefined-os-final/commit/4f2ceaec3abc147ee764b3f6d6e82315a0932236) 前后的两个版本间的内存安全行为进行了排查和验证。

Commit message 如下：

> feat(execve): fix memory leakage on sys_execve
> previously, temp variables in sys_execve will not be dropped

我搭建了一个 Kani 测试环境来进行排查：

- **依赖项处理**：对 `sys_execve` 的部分外部依赖（如 `AxError` 定义、`mm::load_user_app` 模块、`axhal` 底层调用等）进行了 Stubbing，来隔离被测函数的逻辑。
- **符号执行**：在 `mm::load_user_app` 返回的 `entry_point` 和 `user_stack_base`，以及 `MonitoredResource` 的内部 ID 中引入 `kani::any()`，使 Kani 能够遍历所有可能的情况。
- **监控资源释放情况**：在 `MockProcessData` 中引入一个 `MonitoredResource`，在其 `Drop` 实现中会修改一个全局 `AtomicBool` 标志 (`RESOURCE_DROPPED`)，这使得我们能够显式观察数据是否按预期被释放。

### 验证的属性与观察结果

关注的核心属性是 `sys_execve` 执行过程中 `ProcessData` 里的资源（如 `MonitoredResource` 为代表）是否按照 `Drop` 正确释放。

1. 针对修复前版本 :
   - 在此版本中，`ProcessData`（通过 `current_process_data()` 获取，并在其内部包含 `MonitoredResource`）是在一个 Closure 中定义的。因此，该 `MonitoredResource` **确实会在该内部块结束时被正确 `Drop`**。
   - 然而，该函数随后调用 `uctx.enter_uspace()`，这是一个 `-> !` 的函数。这个调用会导致任何在 `enter_uspace` 调用点之前尚未被 `Drop` 的其他局部变量（比如未被完全消耗且需要 `Drop` 的函数参数，例如 `path`、`envs`）将不会由该栈帧的常规 RAII 机制来执行 `Drop`。这构成了此版本中残余的内存安全隐患。
   - Kani 捕获了这一执行路径：在 `MonitoredResource` 被 `Drop` 后，`enter_uspace` 的存根被调用，并按设计触发了 `verify_execve_leak_in_code` 中的 `panic`。Kani 证明了，代码一定会执行到这个 `panic`。
2. 针对修复后版本:
   - 此版本**不再调用 `enter_uspace`**，而是通过修改 `TrapFrame` 并**正常返回 `Ok(0)`** 来完成执行。
   - 由于函数正常返回，所有局部作用域内遵循 RAII 原则的变量（包括 `ProcessData` 及其包含的 `MonitoredResource`，以及其他如 `path`、`envs`、`tf` 相关的资源）都会被正确 `Drop`。
   - Kani 测试 `verify_no_leak_in_fixed_returns_ok_version` 在函数返回后显式断言 `RESOURCE_DROPPED` 标志为 `true`。程序通过了这个 assertion，证明了 `MonitoredResource` 在此版本中得到了正确的释放，从而验证了内存泄漏的修复。

通过这两组 Kani 测试，我们成功地形式化地展示了 `sys_execve` 从一个存在潜在资源释放不完整的状态，到一个能够确保所有局部资源正确清理的更安全状态。

### 如何复现

```
git clone -b kani git@github.com:leverimmy/undefined-os-final.git
```

首先生成 `.axconfig.toml`：

```bash
./scripts/get_deps.sh
cd .arceos && git reset 03682f8f61940b6bc497cbf470115b561dd8219b --soft
cd ..
make defconfig ARCH=x86_64
```

然后对 UndefinedOS 里的 `api/` 进行形式化验证：

```bash
AX_CONFIG_PATH=${PWD}/.axconfig.toml cargo +nightly -Z unstable-options -C api/ kani -Z unstable-options --ignore-global-asm
```

可以看到输出：

```bash
...
Manual Harness Summary:
Complete - 2 successfully verified harnesses, 0 failures, 2 total.
```

## 下一周的工作

